#!/usr/bin/env python3
"""
Simple CLI for InventoryVision AI Social Media Post Generator
Usage: ./post [post_type]
"""

import sys
import os

# Add src to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from dotenv import load_dotenv
from post_generator import load_company_docs, generate_post, format_post_for_platform
from mastodon_client import MastodonClient

def main():
    load_dotenv(override=True)

    # Get post type from command line or use default
    post_type = sys.argv[1] if len(sys.argv) > 1 else "thought_leadership"

    valid_types = ["thought_leadership", "product_update", "industry_insight", "customer_story"]
    if post_type not in valid_types:
        print(f"Invalid post type. Choose from: {', '.join(valid_types)}")
        sys.exit(1)

    try:
        # Load docs and generate post
        print(f"üìö Loading company docs...")
        docs = load_company_docs()

        print(f"ü§ñ Generating {post_type} post...")
        post = generate_post(docs, post_type=post_type, platform="mastodon")

        formatted = format_post_for_platform(post)

        print("\n" + "="*60)
        print("GENERATED POST")
        print("="*60)
        print(f"\n{formatted}")
        print(f"\n({len(formatted)} characters)")
        print("="*60 + "\n")

        # Ask to post (with better handling)
        if len(formatted) > 500:
            print(f"‚ö†Ô∏è  WARNING: Post is {len(formatted)} characters (limit: 500)")
            print("Skipping post due to character limit.")
        else:
            try:
                response = input("Post to Mastodon? (yes/no) [yes]: ").strip().lower()
            except EOFError:
                response = "yes"  # Default to yes in non-interactive mode

            if response in ["", "yes", "y"]:
                print("\nüì§ Posting to Mastodon...")
                mastodon = MastodonClient()
                status = mastodon.post(formatted)
                print(f"‚úÖ Posted: {status['url']}")
            else:
                print("‚è≠Ô∏è  Skipped posting")

    except Exception as e:
        print(f"‚ùå Error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
