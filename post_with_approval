#!/usr/bin/env python3
"""
Generate and Post with Telegram Button Approval
Creates a social media post, sends to Telegram with approve/reject buttons, then posts to Mastodon if approved.
"""

import sys
import os
from dotenv import load_dotenv

# Add src to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from post_generator import generate_post, load_company_docs, format_post_for_platform
from mastodon_client import MastodonClient
from telegram_approval import request_approval, send_notification
from image_generator import generate_image


def main():
    load_dotenv(override=True)

    # Get post type from command line or use default
    post_type = sys.argv[1] if len(sys.argv) > 1 else "thought_leadership"

    print(f"üìù Generating {post_type} post...")

    # Load company docs and generate post
    docs = load_company_docs()
    post = generate_post(docs, post_type=post_type, platform="mastodon")

    # Format for Mastodon
    formatted = format_post_for_platform(post)

    print(f"\n‚úÖ Post generated!")
    print(f"\n{'='*60}")
    print("Generated content:")
    print(formatted)
    print(f"{'='*60}")
    print(f"Character count: {len(formatted)}/500")

    # Check character limit
    if len(formatted) > 500:
        print(f"\n‚ö†Ô∏è  WARNING: Post is {len(formatted)} characters (limit: 500)")
        print("Post is too long. Regenerate with shorter content.")
        send_notification(f"‚ùå Generated post was too long ({len(formatted)} chars)")
        return

    # Generate image using the image_prompt
    print(f"\nüé® Generating image...")
    print(f"   Image prompt: {post.image_prompt}")
    try:
        image_path = generate_image(
            prompt=post.image_prompt,
            aspect_ratio="1:1",  # Square for social media
            num_inference_steps=28,  # Good quality/speed balance
        )
    except Exception as e:
        print(f"\n‚ö†Ô∏è  Image generation failed: {e}")
        print("Continuing without image...")
        image_path = None

    # Request approval via Telegram buttons (with image preview if available)
    print("\nüì± Sending to Telegram for approval...")
    approved, rejection_reason = request_approval(formatted, content_type="post", image_path=image_path)

    if not approved:
        print("\n‚ùå Post was not approved. Cancelled.")
        if rejection_reason:
            print(f"   üìù Rejection reason: {rejection_reason}")
            send_notification(f"‚ùå Post was rejected.\n\nReason: {rejection_reason}")
        else:
            send_notification("‚ùå Post was rejected and not published.")
        return

    # Post to Mastodon with image
    print("\n‚úÖ Posting to Mastodon...")
    mastodon = MastodonClient()
    result = mastodon.post(
        content=formatted,
        media_path=image_path,
        media_description=post.image_prompt  # Use prompt as alt text
    )

    # Send success notification (without markdown to avoid parsing errors)
    post_url = result['url']
    success_message = f"‚úÖ Post published successfully!\n\n{post_url}"
    send_notification(success_message)

    print(f"\n‚úÖ Posted successfully!")
    print(f"URL: {post_url}")


if __name__ == "__main__":
    main()
